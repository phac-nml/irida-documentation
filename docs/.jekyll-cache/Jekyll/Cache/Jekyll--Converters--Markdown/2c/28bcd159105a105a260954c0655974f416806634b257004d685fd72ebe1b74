I"ø"<h1 id="sistr-typing">SISTR Typing</h1>

<p>This workflow uses the software <a href="https://github.com/peterk87/sistr_cmd">sistr_cmd</a> for typing of Salmonella genomes which are first assembled using <a href="https://github.com/tseemann/shovill/">shovill</a>, which uses <a href="http://bioinf.spbau.ru/spades">SPAdes</a> for assembly only and performs pre-assembly read correction with <a href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0509-9">Lighter</a> and post-assembly correction with <a href="https://github.com/lh3/bwa">BWA MEM</a> and <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4237348/">PILON</a>.  The specific Galaxy tools are listed in the table below.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Tool Name</th>
      <th style="text-align: center">Owner</th>
      <th style="text-align: center">Tool Revision</th>
      <th style="text-align: center">Toolshed Installable Revision</th>
      <th style="text-align: center">Toolshed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><strong>shovill</strong></td>
      <td style="text-align: center">iuc</td>
      <td style="text-align: center"><a href="https://toolshed.g2.bx.psu.edu/view/iuc/shovill/f698c7604b3b">f698c7604b3b</a></td>
      <td style="text-align: center">2 (2018-10-07)</td>
      <td style="text-align: center"><a href="http://toolshed.g2.bx.psu.edu/">Galaxy Main Shed</a></td>
    </tr>
    <tr>
      <td style="text-align: center"><strong>sistr_cmd</strong></td>
      <td style="text-align: center">nml</td>
      <td style="text-align: center"><a href="https://toolshed.g2.bx.psu.edu/view/nml/sistr_cmd/5c8ff92e38a9">5c8ff92e38a9</a></td>
      <td style="text-align: center">3 (2017-06-14)</td>
      <td style="text-align: center"><a href="http://toolshed.g2.bx.psu.edu/">Galaxy Main Shed</a></td>
    </tr>
  </tbody>
</table>

<p>To install these tools please proceed through the following steps.</p>

<h2 id="step-1-galaxy-conda-setup">Step 1: Galaxy Conda Setup</h2>

<p>Galaxy makes use of <a href="https://conda.io/docs/intro.html">Conda</a> to automatically install some dependencies for SISTR.  Please verify that the version of Galaxy is &gt;= v16.01 and has been setup to use conda (by modifying the appropriate configuration settings, see <a href="../../setup#step-4-modify-configuration-file">here</a> for additional details).  A method to get SISTR to work with a Galaxy version &lt; v16.01 is available in <a href="../../../faq#4-installing-conda-dependencies-in-galaxy-versions--v1601">FAQ/Conda dependencies</a>.</p>

<h3 id="address-shovill-related-issues">Address shovill related issues</h3>

<h4 id="error-256-from-running-kmcsamtools">Error 256 from running <code>kmc</code>/<code>samtools</code></h4>

<p>You will need to install the correct versions of some dependencies for <code>kmc</code>/<code>samtools</code> so after installing <code>shovill</code>:</p>

<div class="highlight"><pre><code class="language-bash"><span class="c1"># activate the Galaxy shovill conda env</span>
<span class="nb">source</span> galaxy/deps/_conda/bin/activate galaxy/deps/_conda/envs/__shovill@0.9.0
<span class="c1"># install ncurses and bzip2 from conda-forge channel</span>
conda install -c conda-forge ncurses bzip2</code></pre></div>

<h4 id="pilon-javajvm-heap-allocation-issues"><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4237348/">PILON</a> Java/JVM heap allocation issues</h4>

<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4237348/">PILON</a> is a Java application and may require the JVM heap size to be set (e.g. <code>_JAVA_OPTIONS=-Xmx4g</code>).<br />
If <a href="https://github.com/tseemann/shovill/">shovill</a> under Galaxy submits jobs to a <a href="https://slurm.schedmd.com">SLURM</a> workload manager, it may be necessary to allot about 4G more through SLURM than through <a href="https://github.com/tseemann/shovill/">shovill</a> <code>--ram</code> (default is <code>${SHOVILL_RAM:-4}</code> or 4G as of tool revision <a href="https://toolshed.g2.bx.psu.edu/repos/iuc/shovill/rev/57d5928f456e">57d5928f456e</a>) so if you give <a href="https://github.com/tseemann/shovill/">shovill</a> 4G, give the SLURM job 8G.</p>

<p>One way you can adjust the <code>$SHOVILL_RAM</code> environment variable is via the <a href="https://conda.io/docs/user-guide/tasks/manage-environments.html#saving-environment-variables">conda environment</a>. That is, if you find the conda environment containing <code>shovill</code> you can set up files in <code>etc/conda/activate.d</code> and <code>etc/conda/deactivate.d</code> to set environment variables.</p>

<div class="highlight"><pre><code class="language-bash"><span class="nb">cd</span> galaxy/deps/_conda/bin/activate galaxy/deps/_conda/envs/__shovill@0.9.0
mkdir -p etc/conda/activate.d
mkdir -p etc/conda/deactivate.d

<span class="nb">echo</span> -e <span class="s2">&quot;export _OLD_SHOVILL_RAM=\$SHOVILL_RAM\nexport SHOVILL_RAM=8&quot;</span> &gt;&gt; etc/conda/activate.d/shovill-ram.sh
<span class="nb">echo</span> -e <span class="s2">&quot;export SHOVILL_RAM=\$_OLD_SHOVILL_RAM&quot;</span> &gt;&gt; etc/conda/activate.d/shovill-ram.sh</code></pre></div>

<p>You could also get fancier with this by setting <code>SHOVILL_RAM</code> based on <a href="https://planemo.readthedocs.io/en/latest/writing_advanced.html#developing-for-clusters-galaxy-slots-galaxy-memory-mb-and-galaxy-memory-mb-per-slot">GALAXY_MEMORY_MB</a>, which is assigned by Galaxy based on your job configuration and resource requirements. For example, by setting <code>SHOVILL_RAM=$($GALAXY_MEMORY_MB/1024)</code>.</p>

<h2 id="step-2-install-galaxy-tools">Step 2: Install Galaxy Tools</h2>

<p>Please install all the Galaxy tools in the table above by logging into Galaxy, navigating to <strong>Admin &gt; Search and browse tool sheds</strong>, searching for the appropriate <strong>Tool Name</strong> and installing the appropriate <strong>Toolshed Installable Revision</strong>.</p>

<p>The install progress can be checked by monitoring the Galaxy log files <code>galaxy/*.log</code>.  On completion you should see a message of <code>Installed</code> next to the tool when going to <strong>Admin &gt; Manage installed tool shed repositories</strong>.</p>

<h2 id="step-3-testing-pipeline">Step 3: Testing Pipeline</h2>

<p>A Galaxy workflow and some test data has been included with this documentation to verify that all tools are installed correctly.  To test this pipeline, please proceed through the following steps.</p>

<ol>
  <li>Upload the <a href="../test/sistr/sistr.ga">SISTR Typing Galaxy Workflow</a> by going to <strong>Workflow &gt; Upload or import workflow</strong>.</li>
  <li>
    <p>Upload the sequence reads by going to <strong>Analyze Data</strong> and then clicking on the <strong>upload files from disk</strong> icon <img src="../test/snvphyl/images/upload-icon.jpg" alt="upload-icon" />.  Select the <a href="../test/sistr/reads">test/reads</a> files.  Make sure to change the <strong>Type</strong> of each file from <strong>Auto-detect</strong> to <strong>fastqsanger</strong>.  When uploaded you should see the following in your history.</p>

    <p><img src="../test/sistr/images/upload-history.png" alt="upload-history" /></p>
  </li>
  <li>
    <p>Construct a dataset collection of the paired-end reads by clicking the <strong>Operations on multiple datasets</strong> icon <img src="../test/snvphyl/images/datasets-icon.jpg" alt="datasets-icon" />.  Please check off the two <strong>.fastq</strong> files and then go to <strong>For all selectedâ€¦ &gt; Build List of dataset pairs</strong>.  You should see a screen that looks as follows.</p>

    <p><img src="../test/sistr/images/dataset-pair-screen.png" alt="dataset-pair-screen" /></p>
  </li>
  <li>This should have properly paired your data and named the sample <strong>AE014613-699860</strong>.  Enter the name of this paired dataset collection at the bottom and click <strong>Create list</strong>.</li>
  <li>Run the uploaded workflow by clicking on <strong>Workflow</strong>, clicking on the name of the workflow <strong>SISTR Analyze Reads v0.3 (imported from uploaded file)</strong> and clicking <strong>Run</strong>.  This should auto fill in the dataset collection.  At the very bottom of the screen click <strong>Run workflow</strong>.</li>
  <li>
    <p>If everything was installed correctly, you should see each of the tools run successfully (turn green).  On completion this should look like.</p>

    <p><img src="../test/sistr/images/workflow-success.png" alt="workflow-success" /></p>

    <p>If you see any tool turn red, you can click on the view details icon <img src="../test/snvphyl/images/view-details-icon.jpg" alt="view-details-icon" /> for more information.</p>
  </li>
</ol>

<p>If everything was successfull then all dependencies for this pipeline have been properly installed.</p>

:ET