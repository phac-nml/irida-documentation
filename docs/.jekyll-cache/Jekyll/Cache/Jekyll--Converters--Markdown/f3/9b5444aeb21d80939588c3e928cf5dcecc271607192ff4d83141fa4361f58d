I"O;<h1 class="no_toc" id="oauth2-authorization-for-irida">OAuth2 Authorization for IRIDA</h1>

<p>This document describes how a client application can communicate with the IRIDA REST API using OAuth2 Authorization.</p>

<p>In order for a user to access a resource on the REST API, they must first obtain an OAuth2 token from that API.  This token allows a given client and user access to a given resource on the API.  The token is stored by both the client and API.  When the client makes a request to the API they pass along their token which is compared to a list of active issued tokens, then the client is given or denied access based on the validity of that token.</p>

<ul id="markdown-toc">
  <li><a href="#terms" id="markdown-toc-terms">Terms</a></li>
  <li><a href="#authorization-code-grant-type" id="markdown-toc-authorization-code-grant-type">Authorization Code Grant Type</a>    <ul>
      <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
      <li><a href="#obtaining-a-token" id="markdown-toc-obtaining-a-token">Obtaining a Token</a></li>
    </ul>
  </li>
  <li><a href="#password-grant-type" id="markdown-toc-password-grant-type">Password Grant Type</a>    <ul>
      <li><a href="#introduction-1" id="markdown-toc-introduction-1">Introduction</a></li>
      <li><a href="#obtaining-a-token-1" id="markdown-toc-obtaining-a-token-1">Obtaining a Token</a></li>
    </ul>
  </li>
  <li><a href="#using-a-token-to-access-protected-resources" id="markdown-toc-using-a-token-to-access-protected-resources">Using a Token to Access Protected Resources</a></li>
  <li><a href="#examples" id="markdown-toc-examples">Examples</a>    <ul>
      <li><a href="#perl" id="markdown-toc-perl">Perl</a></li>
      <li><a href="#python" id="markdown-toc-python">Python</a></li>
      <li><a href="#java" id="markdown-toc-java">Java</a></li>
    </ul>
  </li>
</ul>

<h2 id="terms">Terms</h2>
<ul>
  <li>REST API - A web API used to create, read, update, or delete resources via HTTP.  See <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">Wikipedia</a>.</li>
  <li>Client - An application which communicates with IRIDA via its REST API.</li>
  <li>Client id - An identifier for a Client shared between the Client and REST API.</li>
  <li>Client secret - A password for a Client shared between the Client and REST API.</li>
  <li>Token - A string of characters used to authorize a User to access a given REST API resource.</li>
  <li>Authorization code - A code generated by OAuth2 which is sent to your web service to exchange for a Token.</li>
</ul>

<h2 id="authorization-code-grant-type">Authorization Code Grant Type</h2>

<h3 id="introduction">Introduction</h3>
<p>A client must provide the correct credentials to obtain a token from the API. If your client is connecting to the REST API via a web service, you will use the “authorization_code” grant type. This will enable the OAuth2 web authorization flow.</p>

<p>For the user, this will happen in 4 steps:</p>

<ol>
  <li>User requests a page requiring an OAuth2 connection to IRIDA.</li>
  <li>User is presented with a login page for the IRIDA REST API.</li>
  <li>User is asked to verify access to their protected resources.</li>
  <li>User is redirected back to your web service and displayed the requested resources.</li>
</ol>

<p>On the server things are a little more complicated:</p>

<ol>
  <li>Your web service requests a resource from IRIDA REST API and receives HTTP 401 (Unauthorized).  This begins the OAuth2 <em>authorization_code</em> flow.</li>
  <li>Your web server redirects the user to <em>/oauth/authorization</em> with parameters to redirect back to your web service once authorization is complete.  This will present the user with a login page from the IRIDA API.</li>
  <li>Once the user completes the login and authorizes your client, they are redirected back to your web service.  This redirect will contain a ?code=XXXX parameter which is the <em>authorization_code</em>.</li>
  <li>Your service sends the authorization code to <em>/oauth/token</em>.  The API will send a response containing an OAuth2 token.</li>
  <li>Your service may then request resources from the API using the token.</li>
</ol>

<p>While this description sounds fairly complicated, whatever web framework you’re using will likely provide an OAuth2 package or library for handling OAuth2 client authorizations.  An incomplete list can be found at http://oauth.net/2/ (look under “Client Libraries”), but you can find more on your web framework’s website.</p>

<h3 id="obtaining-a-token">Obtaining a Token</h3>
<p>Whatever OAuth2 client library you’re using should provide some method to request an OAuth2 token from a server.  The implementation may differ slightly but it should provide a way to set some common <em>client details</em> arguments.  You can generally use the following values:</p>

<ul>
  <li>Grant type - authorization_code</li>
  <li>Authorization location - /oauth/authorize</li>
  <li>Token endpoint - /oauth/token</li>
  <li>Scope - read</li>
  <li>Client id - Your client’s assigned id</li>
  <li>Client secret - Your client’s assigned secret</li>
  <li>Redirect URI - A URI on your site where an authorization code will be sent.</li>
</ul>

<p>Often these libraries will obtain tokens in 2 steps.  The first step will direct the user’s browser to <em>/oauth/authorize</em> on the IRIDA API to obtain an authorization code.  The second will exchange the authorization code for a OAuth2 token.  This token can then be used to request protected resources from the REST API.</p>

<p>After this authorization occurs, the user will not have to re-authorize your service for as long as the token is valid (12 hours by default).  This will require your web service to have some method of storing OAuth2 tokens for a user, otherwise a new token will have to be obtained for each request.</p>

<h2 id="password-grant-type">Password Grant Type</h2>

<h3 id="introduction-1">Introduction</h3>
<p>Similar to the <em>authorization_code</em> grant type, the <em>password</em> grant allows an application to retrieve an OAuth2 token from the REST API, then use it to request resources.  The <em>password</em> grant type differs in that it can be easily used from a desktop application as it doesn’t require the user to log in via a web browser.  The user will provide their IRIDA username and password directly to the application where it will be used to request an OAuth2 token.  Although the <em>password</em> grant type is less complicated for the user and developer, the <em>authorization_code</em> grant is preferred because it doesn’t require the user to pass their username and password directly to the client application.</p>

<p>In the client application:</p>

<ol>
  <li>The client application sends the username, password, client id, and client secret to <em>/oauth/token</em>.  The API will send a response containing an OAuth2 token.</li>
  <li>Your service may then request resources from the API using the token.</li>
</ol>

<h3 id="obtaining-a-token-1">Obtaining a Token</h3>
<p>Whatever OAuth2 client library you’re using should provide some method to request an OAuth2 token from a server.  The implementation may differ slightly but it should provide a way to set some common <em>client details</em> arguments.  You can generally use the following values:</p>

<ul>
  <li>Grant type - password</li>
  <li>Token endpoint - /oauth/token</li>
  <li>Scope - read</li>
  <li>Client id - Your client’s assigned id</li>
  <li>Client secret - Your client’s assigned secret</li>
  <li>Username - The user’s username</li>
  <li>Password - The user’s password</li>
</ul>

<p>These libraries should obtain a token in one request to the server.  It will send all of the client details in an HTTP request to the token endpoint, and the server should respond with an OAuth2 token.  This token can then be used to request protected resources from the REST API.</p>

<h2 id="using-a-token-to-access-protected-resources">Using a Token to Access Protected Resources</h2>
<p>When an OAuth2 token has been obtained it can be used to access protected resource on the IRIDA API.  The token is sent to the REST API using an HTTP header.  Again most OAuth2 libraries will have a method to request resources using this token, but if not they can be easily used with most HTTP request libraries.</p>

<p>A <em>Bearer Authorization</em> header must be added to the HTTP request using the obtained token.  If the token string is “12345”, this header will be of the form:</p>

<div class="highlight"><pre><code class="language-http"><span class="err">Authorization: Bearer 12345</span></code></pre></div>

<p>If the token is valid, you will receive your requested resources.  If not you should receive a HTTP 403 error.</p>

<h2 id="examples">Examples</h2>

<h3 id="perl">Perl</h3>
<ul>
  <li><a href="https://github.com/phac-nml/irida-linker">NGS Archive Linker</a> - An example of a Perl script that connects to the IRIDA API via the OAuth2 <em>password</em> grant.  It uses the <a href="http://search.cpan.org/~ritou/OAuth-Lite2-0.08/lib/OAuth/Lite2/Client/UsernameAndPassword.pm">OAuth::Lite2::Client::UsernameAndPassword</a> package.  The script retrieves a token from the API in the <code>getToken</code> subroutine, then sets an <code>Authorization: Bearer</code> header to be used for all requests.  Some example code can be seen below:</li>
</ul>

<div class="highlight"><pre><code class="language-perl"><span class="k">my</span> <span class="nv">$client</span> <span class="o">=</span> <span class="nn">OAuth::Lite2::Client::UsernameAndPassword</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">id</span>               <span class="o">=&gt;</span> <span class="nv">$client_id</span><span class="p">,</span>
        <span class="n">secret</span>           <span class="o">=&gt;</span> <span class="nv">$client_secret</span><span class="p">,</span>
        <span class="n">access_token_uri</span> <span class="o">=&gt;</span> <span class="nv">$base_url</span><span class="o">.</span><span class="s">&quot;/oauth/token&quot;</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="n">get_access_token</span><span class="p">(</span><span class="n">username</span><span class="o">=&gt;</span><span class="nv">$username</span><span class="p">,</span><span class="n">password</span><span class="o">=&gt;</span><span class="nv">$password</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$tokenstr</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="n">access_token</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$head</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">HTTP::</span><span class="n">Headers</span><span class="p">;</span>
<span class="nv">$head</span><span class="o">-&gt;</span><span class="n">authorization</span><span class="p">(</span><span class="s">&quot;Bearer $tokenstr&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$request</span> <span class="o">=</span> <span class="nn">HTTP::Request</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span><span class="nv">$url</span><span class="p">,</span><span class="nv">$headers</span><span class="p">);</span>
<span class="o">...</span></code></pre></div>

<h3 id="python">Python</h3>
<ul>
  <li><a href="https://github.com/phac-nml/irida-galaxy-importer">NGS Archive Galaxy Linker</a> - This application uses <a href="http://rauth.readthedocs.org/en/latest/">OAuth2Service</a> to contact the IRIDA API via the OAuth2 <em>password</em> grant.  The script retrieves a token in the <code>get_access_token(oauth_service, username, password)</code> subroutine then sets the token credentials for each request in <code>ngs_request(url, oauth_service, access_token)</code>.  Some example code is below:</li>
</ul>

<div class="highlight"><pre><code class="language-python"><span class="n">oauth_serv</span> <span class="o">=</span> <span class="n">OAuth2Service</span><span class="p">(</span>
    <span class="n">client_id</span><span class="o">=</span><span class="n">clientId</span><span class="p">,</span>
    <span class="n">client_secret</span><span class="o">=</span><span class="n">clientSecret</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;irida&quot;</span><span class="p">,</span>
    <span class="n">access_token_url</span> <span class="o">=</span> <span class="n">baseURL</span> <span class="o">+</span> <span class="s2">&quot;oauth/token&quot;</span><span class="p">,</span>
    <span class="n">base_url</span><span class="o">=</span><span class="n">baseURL</span><span class="p">)</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;grant_type&#39;</span> <span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span>
        <span class="s1">&#39;client_id&#39;</span> <span class="p">:</span> <span class="n">clientId</span><span class="p">,</span>
        <span class="s1">&#39;client_secret&#39;</span> <span class="p">:</span> <span class="n">clientSecret</span><span class="p">,</span>
        <span class="s1">&#39;username&#39;</span> <span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s1">&#39;password&#39;</span> <span class="p">:</span> <span class="n">password</span><span class="p">}}</span>

<span class="n">access_token</span> <span class="o">=</span> <span class="n">oauth_service</span><span class="o">.</span><span class="n">get_access_token</span><span class="p">(</span><span class="n">decoder</span><span class="o">=</span><span class="n">decoder</span><span class="p">,</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">oauth_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="o">...</span></code></pre></div>

<h3 id="java">Java</h3>
<ul>
  <li><a href="https://github.com/phac-nml/irida/tree/development/samples/oauth-web-client">IRIDA OAuth2 Web Client Demo</a> - This is a sample web application demoing the use of the <em>authorization_code</em> OAuth2 grant type using <a href="http://projects.spring.io/spring-security-oauth/">Spring Security OAuth</a>.</li>
</ul>
:ET